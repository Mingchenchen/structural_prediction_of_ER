! THIS PROGRAM TAKES IN THE OUTPUT FILES *.asa GENERATED BY PROGRAM dynamic_asa.f90 and normalizes the ASA values by the maximum ASAs found by Tien et al. (2013).
! AMIR SHAHMORADI, SATURDAY 6:57 PM, OCT 26, 2013, ICMB, UT AUSTIN

module aa_dictionary
	implicit none
	integer, parameter :: aa_num = 20
	character(len=1), dimension(aa_num) :: aa_dict = ['A','R','N','D','C','Q','E','G','H','I','L','K','M','F','P','S','T','W','Y','V']
	real*8, dimension(aa_num) :: max_rsa = [129.,274.,195.,193.,167.,225.,223.,104.,224.,197.,201.,236.,224.,240.,159.,155.,172.,285.,263.,174.]
end module aa_dictionary

program rsa_calculator
implicit none
integer :: i,nres,ntraj=-3,ios,idummy
integer :: nitems	! function
real*8, dimension(:,:), allocatable :: rsa
integer, dimension(:), allocatable :: res_num
character(len=2), dimension(:), allocatable :: chain_id,res_name
CHARACTER(LEN=300) :: asa_in			! ASA file generated by dynamic_asa.f90.
CHARACTER(LEN=300) :: rsa_out			! RSA file containing the normalized ASA values.
CHARACTER(LEN=300) :: rsa_sum			! RSA summary file (containing the average, median, stdev).
character(len=15000) :: line
character(len=15) :: dummy_char
character(len=100) :: asa_output_format,res_output_format,resnum_output_format
real*8 :: MRSA_finder,select	! functions
real*8 :: max_rsa,mean_rsa,med_rsa,stdev_rsa,var_rsa

if (command_argument_count()/=3) then
	write(*,*)
	write(*,*) "Incorrect number of input arguments on the command line."
	write(*,*) "Correct use:"
	write(*,*) "./a.out <input asa file> <ouput rsa file> <output rsa summary file>"
	write(*,*)
	stop
end if
call get_command_argument(1,asa_in)
call get_command_argument(2,rsa_out)
call get_command_argument(3,rsa_sum)

! NOW DETERMINE THE NUMBER OF COLUMNS AND LINES IN THE INPUT ASA FILE. 
	open(unit=11,file=trim(adjustl(asa_in)),status='old')
	read(11,'(1A15000)') line
	nres = nitems(line)-1
	write(*,*) '# of residues in ASA file: ',nres
	do
		read(11,'(1A15000)',iostat=ios) line
		if (ios<0) then
			exit
		elseif (ios>0) then
			write(*,*) 'Sum Tin Wong! : PDB file broken.'; stop
		else
			ntraj = ntraj + 1
		end if
		cycle
	end do
	write(*,*) '# of MD trajectories in ASA file: ',ntraj
	close(11)

open(unit=11,file=trim(adjustl(asa_in)),status='old')
open(unit=21,file=trim(adjustl(rsa_out)),status='replace')
open(unit=22,file=trim(adjustl(rsa_sum)),status='replace')

allocate(rsa(0:ntraj,nres),res_num(nres),res_name(nres),chain_id(nres))

! NOW PREPARE THE ASA OUTPUT FILE.
	write(dummy_char,*) nres
	asa_output_format = trim(adjustl('(1I15,' // trim(adjustl(dummy_char)) // 'E15.5)'))
	resnum_output_format = trim(adjustl('(1A15,' // trim(adjustl(dummy_char)) // 'I15)'))
	res_output_format = trim(adjustl('(1A15,' // trim(adjustl(dummy_char)) // 'A15)'))

! NOW WRITE THE HEADER OF THE OUTPUT FILE
	read(11,res_output_format) dummy_char,res_name(1:nres)
	write(21,res_output_format) dummy_char,res_name(1:nres)
	read(11,resnum_output_format) dummy_char,res_num(1:nres)
	write(21,resnum_output_format) dummy_char,res_num(1:nres)
	read(11,res_output_format) dummy_char,chain_id(1:nres)
	write(21,res_output_format) dummy_char,chain_id(1:nres)

! NOW READ THE ASA VALUES.
	do i = 0,ntraj
		read(11,asa_output_format) idummy,rsa(i,1:nres)
		if (idummy/=i) then; write(*,*) 'idummy /= i : ', idummy, i; stop; end if
	end do
	
! NOW NORMALIZE THE ASA VALUES AND WRITE THEM IN THE OUTPUT FILE.
	do i = 1,nres
		max_rsa = MRSA_finder(trim(adjustl(res_name(i))))
		rsa(0:ntraj,i) = rsa(0:ntraj,i)/max_rsa
	end do
	do i = 0,ntraj
		write(21,asa_output_format) i,rsa(i,1:nres)
	end do

! NOW WRITE OUT THE RSA SUMMARY FILE.
	write(22,'(7A15)') 'AMINO_ACID','RES_NUM','CHAIN','CRYSTAL_RSA','MEAN_RSA','MEDIAN_RSA','VAR_RSA'
	do i = 1,nres
		call avevar(rsa(1:ntraj,i),ntraj,mean_rsa,var_rsa)
		!stdev_rsa = sqrt(var_rsa)
		!write(*,*) mean_rsa_dummy
		!write(*,*) mean_rsa
		med_rsa = select(ntraj/2,ntraj,rsa(1:ntraj,i))
		write(22,'(1A15,1I15,1A15,4E15.5)') res_name(i),res_num(i),chain_id(i),rsa(0,i),mean_rsa,med_rsa,var_rsa
	end do

end program rsa_calculator

include 'func_nitems.f90'
include 'func_MRSA_finder.f90'
include 'func_select.f90'
include 'sub_avevar.f90'




! Amir Shahmoradi, Monday 4:38 PM, January 27, 2014, WilkeLab, UT Austin.

! ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN-ATTN:
	
!		The input pdb file to the code must be the modified pdb file generated by Amber that has ALL the atoms added to the original pdb structure prior to the MD simulation. A qualified pdb file is the one with a file name that ends with either *_bres.pdb or *_amber.pdb. The former is preferred as the input, since the generated output pdb file by the code will then have three-letter amino acid names that are consistent with and recognized by other software packages such as VMD.

program b_factor
implicit none
integer :: i,j,ios=0,frame=0
integer :: natoms=0,nions=0,nres	    ! total number of protein atoms and ions and residues in the amber pdb file
character(len=300) :: pdb_in			! pdb file must be free of any non amino acid atoms, except na+ and cl- ions that are automatically handled by the code.
character(len=300) :: bf_out			! the output file that contains the b-factor information for the requested atom of each residue.
character(len=300) :: command			! the command to be executed in shell.
character(len=30) :: atom_in			! the atom in each residue for which the b-factors are going to be extracted. Example: CA, ..., or ALL (not implemented in this version).
character(len=6) :: record
character(len=4) :: atom_name
character(len=3) :: res_name
character(len=1) :: chain_id
integer :: res_num
character(len=1) :: alt_loc_ind,res_code
integer :: atom_num
real*8  :: occupancy,bfactor,dummy
real*8, dimension(3) :: crd
logical :: protein_stat=.true.

if (command_argument_count()/=3) then
	write(*,*)
	write(*,*) "Invalid number of input arguments on the command line."
	write(*,*) "Correct use:"
	write(*,'(1A100)') "./a.out <input pdb file> <atom name (e.g., CA, N, or ALL> <output CN file>"
	write(*,*)
	stop
end if
call get_command_argument(1,pdb_in)
call get_command_argument(2,atom_in)
	if (trim(adjustl(atom_in)/='CA') then
		write(*,'(1A115)') 'The current version of the code only accepts CA (alpha-carbon) atom name as the input file.'
		write(*,*) 'Use CA as the command-line argument for atom name.'
	end if
call get_command_argument(3,bf_out)

open(unit=11,file=trim(adjustl(pdb_in)),status='old')
open(unit=21,file=trim(adjustl(bf_out)),status='replace')
write(21,'(6A10)') 'chain_id', 'res_num', 'res_name', 'atom_num', 'atom_name', 'bfactor'

! FIRST DETERMINE THEW NUMBER OF ATOMS IN THE PDB FILE (EXCLUDING THE IONS: ONLY Na+ & Cl- ARE CONSIDERED AT THE MOMENT).
	
	do
		read(11,'(1A4)') record
		if (trim(adjustl(record))=='ATOM') exit
		!write(*,'(1A4)') record
		cycle
	end do
	
	backspace(unit=11)
		
	do
		read(11,'(A6,I5,1X,A4,A1,A3,1X,A1,I4,A1,3X,3F8.3,2F6.2)',iostat=ios) record,atom_num,atom_name,alt_loc_ind,res_name,chain_id,res_num,res_code,(crd(j),j=1,3),occupancy,bfactor
		if (ios<0) then
			exit
		elseif (ios>0) then
			write(*,*) 'Sum Tin Wong! : PDB file broken.'; stop
		else
			if (trim(adjustl(atom_name))=='Na+' .or. trim(adjustl(atom_name))=='Cl-' .or. trim(adjustl(atom_name))=='SOD' .or. trim(adjustl(atom_name))=='CLA') then
				nions = nions + 1
				protein_stat = .false.
			elseif (trim(adjustl(record))=='TER' .and. protein_stat) then
				write(21,'(A3)') 'TER'
			elseif (trim(adjustl(record))=='END') then
				write(21,'(A3)') 'END'
				exit
			elseif (trim(adjustl(record))/='ATOM') then
				write(*,*) 'non ATOM record in the pdb file: ', trim(adjustl(record))
				protein_stat = .false.
			elseif (protein_stat) then
				if (chain_id(1) == " ") chain_id(1) = 'X'
				!write(21,'(A6,I5,1X,A4,A1,A3,1X,A1,I4,A1,3X,3F8.3,2F6.2)') record,atom_num,atom_name,alt_loc_ind,res_name(1),chain_id(1),res_num(1),res_code,(crd(j),j=1,3),occupancy,bfactor
				if (trim(adjustl(atom_name)) == atom_in) then
					write(21,'(A10,I10,A10,I10,A10,F10.2)') chain_id, res_num, res_name, atom_num, atom_name, bfactor
				end do
				nres = res_num(1)
				natoms = natoms + 1
			end if
			cycle
		end if
	end do

	close(11); close(21)
	write(*,*); write(*,'(1A8,1I8)') "natoms: ",natoms; write(*,'(1A8,1I8)') "nions: ",nions
	write(*,'(1A8,1I8)') "ntot: ",natoms+nions; write(*,'(1A8,1I8)') "nres: ",nres

END PROGRAM b_factor